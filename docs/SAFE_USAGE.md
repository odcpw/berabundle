# Safe Multisig Wallet Integration

This document explains how to use the Safe multisig wallet integration in BeraBundle.

## Overview

BeraBundle supports proposing transactions to Safe multisig wallets through direct integration with the Safe Transaction Service API. This allows users to:

1. Prepare bundles of transactions
2. Propose these transactions to their Safe multisig wallet
3. View and execute the transactions in the Safe web interface

## Architecture

The Safe integration consists of two main components:

1. **SafeAdapter** (`execution/adapters/safeAdapter.js`): Provides direct interaction with the Safe Transaction Service API, including:
   - Transaction hash calculation (EIP-712)
   - Transaction signing
   - Transaction proposal
   - Transaction confirmation

2. **SafeExecutor** (`execution/executors/safeExecutor.js`): Implements the executor interface for Safe transactions, handling:
   - Bundle conversion from EOA to Safe format
   - Transaction execution (proposal)
   - Transaction confirmation

## Usage

### Proposing a Transaction

To propose a transaction to a Safe multisig wallet:

```javascript
const SafeExecutor = require('./execution/executors/safeExecutor');

// Initialize the executor
const executor = new SafeExecutor();

// Prepare execution options
const options = {
    safeAddress: '0x561EF9Fdf5341EF3815E69E1010067b7EF179dad', // Your Safe address
    bundle: bundleObject, // The bundle with transactions
    signerAddress: '0x6c6eEbcBd13e2BBeC88e44f298B17Dea0d2ce46F', // Your address
    password: 'your-secure-password' // Password to decrypt your private key
};

// Execute (propose) the transaction
const result = await executor.execute(options);

if (result.success) {
    console.log(`Transaction proposed successfully: ${result.transactionUrl}`);
} else {
    console.error(`Failed to propose transaction: ${result.message}`);
}
```

### Confirming a Transaction

To confirm an existing transaction:

```javascript
const SafeExecutor = require('./execution/executors/safeExecutor');

// Initialize the executor
const executor = new SafeExecutor();

// Confirm the transaction
const result = await executor.confirmTransaction(
    '0x561EF9Fdf5341EF3815E69E1010067b7EF179dad', // Safe address
    '0x525e07a7ae5ba201e2b3e79c8a8f02e1ebd0f49feafa6a5de25f3ef0f8f00cbd', // Transaction hash
    '0x6c6eEbcBd13e2BBeC88e44f298B17Dea0d2ce46F', // Your address
    'your-secure-password' // Password to decrypt your private key
);

if (result.success) {
    console.log(`Transaction confirmed successfully!`);
} else {
    console.error(`Failed to confirm transaction: ${result.message}`);
}
```

### Finding Your Safes

To find Safe wallets where you are an owner:

```javascript
const SafeExecutor = require('./execution/executors/safeExecutor');

// Initialize the executor
const executor = new SafeExecutor();

// Find Safes where you are an owner
const result = await executor.getSafesByOwner('0x6c6eEbcBd13e2BBeC88e44f298B17Dea0d2ce46F');

if (result.success) {
    console.log(`Found ${result.safes.length} Safe(s): ${result.safes.join(', ')}`);
} else {
    console.error(`Failed to find Safes: ${result.message}`);
}
```

## Technical Details

### Transaction Signature Generation

The Safe Transaction Service requires a proper EIP-712 signature. The signature is generated by:

1. Calculating the transaction hash according to the Safe contract's specifications
2. Signing the hash using the user's private key (after decryption)
3. Formatting the signature in the format expected by the Safe Transaction Service

### Bundle Formats

The system handles two main bundle formats:

1. **EOA Format**: Standard format used for regular (non-multisig) wallets
2. **Safe UI Format**: Format with specially structured transactions for Safe multisig wallets

The `convertEoaToSafeFormat` method in SafeAdapter can be used to convert between these formats.

## Testing

A test file is provided to verify the Safe integration:

```
node test-safe-executor.js
```

This will find the most recent Safe UI bundle and propose it to the configured Safe address.